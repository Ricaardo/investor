# 一、项目目标（先把边界定死）

## 🎯 核心目标

* 一个 **可在飞书 (Feishu) 私聊 / 群聊对话的机器人**
* **不依赖具体大模型平台**（你自定义接口）
* 主要用于 **投资分析 / 决策辅助**
* **不需要 @ 也可对话（在可控范围内）**
* 使用 **长连接 (WebSocket)** 模式，**免公网 IP，免内网穿透**。

## 🚫 明确不做的事

* 不直接给买卖指令
* 不接券商下单
* 不做“预测一定涨跌”

---

# 二、总体架构（核心设计）

### 🧠 总体原则

> **飞书只是“一个入口”，
> 真正的产品是「AI 投资机器人内核」**

---

## 1️⃣ 总体架构图（文字版）

```
┌────────────────────┐
│      飞书客户端      │
│  (私聊 / 群聊)       │
└─────────▲──────────┘
          │
          │ WebSocket (长连接)
          │
┌─────────┴──────────┐
│ 飞书 Adapter        │  ← 负责协议转换 (Lark SDK)
│ - 事件订阅 (WS)     │
│ - 消息解析          │
│ - 消息发送          │
└─────────▲──────────┘
          │ 统一内部消息
┌─────────┴──────────┐
│ AI 投资机器人内核   │  ← 核心 (复用原架构)
│                    │
│ 1. Session 管理     │
│ 2. 意图识别         │
│ 3. 投资 Agent 调度  │
│ 4. 风控 & 合规      │
│ 5. Prompt 管理      │
└─────────▲──────────┘
          │
┌─────────┴──────────┐
│ 模型接口层（LLM）   │
│ - DeepSeek          │
│ - OpenAI / Claude   │
└─────────▲──────────┘
```

---

# 三、飞书接入层（Adapter 设计）

## 1️⃣ 接入方式

* **飞书自建应用 (机器人)**
* 使用 **WebSocket 长连接** (无需公网 IP)
* 消息类型：
  * 私聊文本 (`im.message.receive_v1`)
  * 群聊 @ 消息

## 2️⃣ Adapter 职责

✅ 只做三件事：

1. 建立 WebSocket 连接监听事件
2. 转换为「统一内部消息格式」
3. 调用飞书 API 发送回复

---

## 3️⃣ 内部统一消息协议（保持不变）

```go
type InternalMessage struct {
    Platform    string `json:"platform"`     // "feishu"
    ChatType    string `json:"chat_type"`    // "p2p", "group"
    ChatID      string `json:"chat_id"`      // 会话ID (OpenChatID)
    UserID      string `json:"user_id"`      // 发送者ID (OpenID)
    Text        string `json:"text"`         // 消息内容
    // ...
}
```

---

# 四、环境变量配置 (.env)

```ini
# Server
PORT=8081

# Feishu (Lark)
FEISHU_APP_ID=cli_xxx
FEISHU_APP_SECRET=xxx
FEISHU_ENCRYPT_KEY=xxx (可选)
FEISHU_VERIFICATION_TOKEN=xxx (可选)

# LLM
LLM_PROVIDER=deepseek
LLM_API_KEY=sk-xxx
LLM_API_URL=https://api.deepseek.com
```

---

# 五、实施步骤 (迁移到飞书)

1. **配置更新**: 添加飞书相关环境变量。
2. **Adapter 实现**: 使用 `github.com/larksuite/oapi-sdk-go/v3` 实现 WebSocket 客户端。
3. **主程序切换**: 在 `main.go` 中替换 WeCom Adapter 为 Feishu Adapter。
4. **测试**: 启动服务，在飞书与机器人对话。
